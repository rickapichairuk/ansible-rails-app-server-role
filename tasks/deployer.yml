- name: Add deployment user
  action: user name={{deployer.username}}

- name: Add ssh public keys to authorized_keys
  authorized_key: user={{deployer.username}} key={{ item }}
  with_items: "{{ deployer.authorized_keys }}"

- name: Remove sudo group rights
  action: lineinfile dest=/etc/sudoers regexp="^%sudo" state=absent

- name: Remove deploy user from sudoers
  action: lineinfile dest=/etc/sudoers regexp="{{deployer.username}} ALL" line="{{deployer.username}} ALL=(ALL) NOPASSWD:ALL" state=absent

- name: Install ssh private key
    copy: 
      content: "{{deployer.ssh_private_key}}"
      dest: "{{deployer.username}}/.ssh/id_rsa"
      owner: "{{deployer.username}}"
      mode: 0400

- name: Install ssh public key
    copy: 
      content: "{{deployer.ssh_public_key}}"
      dest: "{{deployer.username}}/.ssh/id_rsa.pub"
      owner: "{{deployer.username}}"
      mode: 0400

- name: Allow deploy to restart sidekiq workers
  action: lineinfile dest=/etc/sudoers regexp="{{deployer.username}} ALL" line="{{deployer.username}} ALL=(ALL) NOPASSWD:/sbin/systemctl start sidekiq.service, /sbin/systemctl stop sidekiq.service, /sbin/systemctl status sidekiq.service, /sbin/systemctl restart sidekiq.service, /sbin/systemctl stop puma.service, /sbin/systemctl start puma.service, /sbin/systemctl restart puma.service, /sbin/systemctl status puma.service, /sbin/systemctl stop nginx.service, /sbin/systemctl start nginx.service, /sbin/systemctl restart nginx.service, /sbin/systemctl status nginx.service" state=present
